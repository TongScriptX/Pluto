name: ğŸ‘¥ Contributors Statistics

on:
  schedule:
    # æ¯å°æ—¶æ›´æ–°
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate contributors list
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è·å–è´¡çŒ®è€…ä¿¡æ¯
            const { data: contributors } = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // è·å–ä»“åº“ä¿¡æ¯
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // ç”Ÿæˆè´¡çŒ®è€…åˆ—è¡¨
            let contributorsMd = '## ğŸŒŸ è´¡çŒ®è€…\n\n';
            contributorsMd += 'æ„Ÿè°¢æ‰€æœ‰ä¸º Pluto é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼\n\n';
            contributorsMd += '<!-- æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘ -->\n\n';
            
            // æŒ‰è´¡çŒ®æ¬¡æ•°æ’åº
            contributors.sort((a, b) => b.contributions - a.contributions);
            
            // è´¡çŒ®è€…ç»Ÿè®¡
            let totalContributions = 0;
            let totalContributors = contributors.length;
            
            contributorsMd += '### ğŸ“Š è´¡çŒ®ç»Ÿè®¡\n\n';
            contributorsMd += `- ğŸ‘¥ æ€»è´¡çŒ®è€…: ${totalContributors}\n`;
            contributorsMd += `- ğŸ¯ æ€»æäº¤æ¬¡æ•°: ${contributors.reduce((sum, c) => sum + c.contributions, 0)}\n`;
            contributorsMd += `- â­ é¡¹ç›® Stars: ${repo.stargazers_count}\n`;
            contributorsMd += `- ğŸ´ é¡¹ç›® Forks: ${repo.forks_count}\n\n`;
            
            // è´¡çŒ®è€…åˆ—è¡¨
            contributorsMd += '### ğŸ† è´¡çŒ®è€…æ¦œå•\n\n';
            
            // åˆ†çº§æ˜¾ç¤º
            const tiers = {
              'ğŸ¥‡ æ ¸å¿ƒè´¡çŒ®è€…': 10,
              'ğŸ¥ˆ æ´»è·ƒè´¡çŒ®è€…': 5,
              'ğŸ¥‰ è´¡çŒ®è€…': 1
            };
            
            let currentTier = '';
            contributors.forEach((contributor, index) => {
              const contributions = contributor.contributions;
              let tier = '';
              
              if (contributions >= 10) tier = 'ğŸ¥‡ æ ¸å¿ƒè´¡çŒ®è€…';
              else if (contributions >= 5) tier = 'ğŸ¥ˆ æ´»è·ƒè´¡çŒ®è€…';
              else tier = 'ğŸ¥‰ è´¡çŒ®è€…';
              
              if (tier !== currentTier) {
                if (currentTier) contributorsMd += '\n';
                contributorsMd += `#### ${tier}\n\n`;
                currentTier = tier;
              }
              
              contributorsMd += `- [${contributor.login}](https://github.com/${contributor.login}) - ${contributions} æ¬¡è´¡çŒ®\n`;
            });
            
            // æ–°è´¡çŒ®è€…æ¬¢è¿
            const recentContributors = contributors
              .filter(c => c.type === 'User')
              .slice(0, 5);
            
            if (recentContributors.length > 0) {
              contributorsMd += '\n### ğŸ‰ æœ€æ–°åŠ å…¥çš„è´¡çŒ®è€…\n\n';
              recentContributors.forEach(contributor => {
                contributorsMd += `- æ¬¢è¿ [@${contributor.login}](https://github.com/${contributor.login})! ğŸŠ\n`;
              });
            }
            
            // è´¡çŒ®æŒ‡å—
            contributorsMd += '\n### ğŸ¤ å¦‚ä½•è´¡çŒ®\n\n';
            contributorsMd += 'æƒ³è¦æˆä¸ºè´¡çŒ®è€…å—ï¼ŸæŸ¥çœ‹æˆ‘ä»¬çš„ [è´¡çŒ®æŒ‡å—](CONTRIBUTING.md) äº†è§£å¦‚ä½•å‚ä¸é¡¹ç›®ï¼\n\n';
            contributorsMd += '- ğŸ› æŠ¥å‘Š Bug\n';
            contributorsMd += '- âœ¨ æå‡ºæ–°åŠŸèƒ½å»ºè®®\n';
            contributorsMd += '- ğŸ“ æ”¹è¿›æ–‡æ¡£\n';
            contributorsMd += '- ğŸ› ï¸ æäº¤ä»£ç \n';
            contributorsMd += '- ğŸŒ ç¿»è¯‘å’Œæœ¬åœ°åŒ–\n';
            
            contributorsMd += '\n---\n';
            contributorsMd += '<div align="center">\n';
            contributorsMd += '<sub>æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN') + '</sub>\n';
            contributorsMd += '</div>\n';
            
            // å†™å…¥æ–‡ä»¶
            fs.writeFileSync('CONTRIBUTORS.md', contributorsMd);
            console.log('Contributors list updated successfully');

      - name: Commit updated contributors
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update contributors list"
          file_pattern: "CONTRIBUTORS.md"
          commit_user_name: "GitHub Action"
          commit_user_email: "action@github.com"
          skip_dirty_check: false
          create_branch: false
          push_options: '--force-with-lease'
          skip_fetch: false

  generate-contributors-image:
    runs-on: ubuntu-latest
    needs: update-contributors
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate contributors image
        uses: lowlighter/metrics@latest
        with:
          filename: assets/contributors.svg
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ""
          plugin_contributors: yes
          plugin_contributors_head: master
          plugin_contributors_tail: master
          plugin_contributors_organizations: yes
          plugin_contributors_details: percentage, days
          plugin_contributors_sections: base, recent
          config_timezone: Asia/Shanghai
          config_output: svg