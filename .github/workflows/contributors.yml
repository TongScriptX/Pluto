name: ğŸ‘¥ Contributors Statistics

on:
  push:
    branches: [ main ]
  issues:
    types: [opened, closed, reopened, edited]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    # åªåœ¨pushåˆ°mainåˆ†æ”¯æˆ–issueäº‹ä»¶æ—¶è¿è¡Œ
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'issues'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate contributors list
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è·å–è´¡çŒ®è€…ä¿¡æ¯
            const { data: contributors } = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // è·å–ä»“åº“ä¿¡æ¯
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // è·å–issueä¿¡æ¯
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });
            
            // æå–issueè´¡çŒ®è€…
            const issueContributors = new Map();
            issues.forEach(issue => {
              if (issue.user && issue.user.type === 'User') {
                const username = issue.user.login;
                if (!issueContributors.has(username)) {
                  issueContributors.set(username, {
                    login: username,
                    contributions: 0,
                    type: 'User',
                    issue_contributions: 0
                  });
                }
                issueContributors.get(username).issue_contributions++;
              }
            });
            
            // åˆå¹¶ä»£ç è´¡çŒ®è€…å’Œissueè´¡çŒ®è€…
            const allContributors = new Map();
            
            // æ·»åŠ ä»£ç è´¡çŒ®è€…
            contributors.forEach(contributor => {
              allContributors.set(contributor.login, {
                ...contributor,
                issue_contributions: 0
              });
            });
            
            // æ·»åŠ issueè´¡çŒ®è€…
            issueContributors.forEach((contributor, username) => {
              if (allContributors.has(username)) {
                allContributors.get(username).issue_contributions = contributor.issue_contributions;
              } else {
                allContributors.set(username, contributor);
              }
            });
            
            // ç”Ÿæˆè´¡çŒ®è€…åˆ—è¡¨
            let contributorsMd = '## ğŸŒŸ è´¡çŒ®è€…\n\n';
            contributorsMd += 'æ„Ÿè°¢æ‰€æœ‰ä¸º Pluto é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼åŒ…æ‹¬ä»£ç è´¡çŒ®å’ŒIssueåé¦ˆã€‚\n\n';
            contributorsMd += '<!-- æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘ -->\n\n';
            
            // è½¬æ¢ä¸ºæ•°ç»„å¹¶æŒ‰æ€»è´¡çŒ®æ¬¡æ•°æ’åº
            const sortedContributors = Array.from(allContributors.values()).sort((a, b) => {
              const totalA = a.contributions + a.issue_contributions;
              const totalB = b.contributions + b.issue_contributions;
              return totalB - totalA;
            });
            
            // è´¡çŒ®è€…ç»Ÿè®¡
            const totalContributors = sortedContributors.length;
            const totalCodeContributions = sortedContributors.reduce((sum, c) => sum + c.contributions, 0);
            const totalIssueContributions = sortedContributors.reduce((sum, c) => sum + c.issue_contributions, 0);
            
            contributorsMd += '### ğŸ“Š è´¡çŒ®ç»Ÿè®¡\n\n';
            contributorsMd += `- ğŸ‘¥ æ€»è´¡çŒ®è€…: ${totalContributors}\n`;
            contributorsMd += `- ğŸ’» ä»£ç æäº¤: ${totalCodeContributions} æ¬¡\n`;
            contributorsMd += `- ğŸ› Issueåé¦ˆ: ${totalIssueContributions} ä¸ª\n`;
            contributorsMd += `- â­ é¡¹ç›® Stars: ${repo.stargazers_count}\n`;
            contributorsMd += `- ğŸ´ é¡¹ç›® Forks: ${repo.forks_count}\n\n`;
            
            // è´¡çŒ®è€…åˆ—è¡¨
            contributorsMd += '### ğŸ† è´¡çŒ®è€…æ¦œå•\n\n';
            
            // åˆ†çº§æ˜¾ç¤ºï¼ˆåŸºäºæ€»è´¡çŒ®ï¼‰
            const tiers = {
              'ğŸ¥‡ æ ¸å¿ƒè´¡çŒ®è€…': 10,
              'ğŸ¥ˆ æ´»è·ƒè´¡çŒ®è€…': 5,
              'ğŸ¥‰ è´¡çŒ®è€…': 1
            };
            
            let currentTier = '';
            sortedContributors.forEach((contributor, index) => {
              const totalContrib = contributor.contributions + contributor.issue_contributions;
              let tier = '';
              
              if (totalContrib >= 10) tier = 'ğŸ¥‡ æ ¸å¿ƒè´¡çŒ®è€…';
              else if (totalContrib >= 5) tier = 'ğŸ¥ˆ æ´»è·ƒè´¡çŒ®è€…';
              else tier = 'ğŸ¥‰ è´¡çŒ®è€…';
              
              if (tier !== currentTier) {
                if (currentTier) contributorsMd += '\n';
                contributorsMd += `#### ${tier}\n\n`;
                currentTier = tier;
              }
              
              let contributionText = `${contributor.contributions} æ¬¡ä»£ç æäº¤`;
              if (contributor.issue_contributions > 0) {
                contributionText += ` + ${contributor.issue_contributions} ä¸ªIssue`;
              }
              
              contributorsMd += `- [${contributor.login}](https://github.com/${contributor.login}) - ${contributionText}\n`;
            });
            
            // æ–°è´¡çŒ®è€…æ¬¢è¿
            const recentContributors = contributors
              .filter(c => c.type === 'User')
              .slice(0, 5);
            
            if (recentContributors.length > 0) {
              contributorsMd += '\n### ğŸ‰ æœ€æ–°åŠ å…¥çš„è´¡çŒ®è€…\n\n';
              recentContributors.forEach(contributor => {
                contributorsMd += `- æ¬¢è¿ [@${contributor.login}](https://github.com/${contributor.login})! ğŸŠ\n`;
              });
            }
            
            // è´¡çŒ®æŒ‡å—
            contributorsMd += '\n### ğŸ¤ å¦‚ä½•è´¡çŒ®\n\n';
            contributorsMd += 'æƒ³è¦æˆä¸ºè´¡çŒ®è€…å—ï¼ŸæŸ¥çœ‹æˆ‘ä»¬çš„ [è´¡çŒ®æŒ‡å—](CONTRIBUTING.md) äº†è§£å¦‚ä½•å‚ä¸é¡¹ç›®ï¼\n\n';
            contributorsMd += '- ğŸ› æŠ¥å‘Š Bug\n';
            contributorsMd += '- âœ¨ æå‡ºæ–°åŠŸèƒ½å»ºè®®\n';
            contributorsMd += '- ğŸ“ æ”¹è¿›æ–‡æ¡£\n';
            contributorsMd += '- ğŸ› ï¸ æäº¤ä»£ç \n';
            contributorsMd += '- ğŸŒ ç¿»è¯‘å’Œæœ¬åœ°åŒ–\n';
            
            contributorsMd += '\n---\n';
            contributorsMd += '<div align="center">\n';
            contributorsMd += '<sub>æœ€åæ›´æ–°: ' + new Date().toLocaleString('zh-CN') + '</sub>\n';
            contributorsMd += '</div>\n';
            
            // å†™å…¥æ–‡ä»¶
            fs.writeFileSync('CONTRIBUTORS.md', contributorsMd);
            console.log('Contributors list updated successfully');

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated contributors
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update contributors list"
          file_pattern: "CONTRIBUTORS.md"
          commit_user_name: "GitHub Action"
          commit_user_email: "action@github.com"
          skip_dirty_check: false
          create_branch: false
          push_options: '--force-with-lease'
          skip_fetch: false
          branch: main