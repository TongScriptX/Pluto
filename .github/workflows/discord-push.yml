name: 🔔 Discord Commit Notifier

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse commit and send to both webhooks
        env:
          WEBHOOK1: ${{ secrets.DISCORD_GITHUB_UPDATE }}
          WEBHOOK2: ${{ secrets.DISCORD_GITHUB_UPDATE2 }}
        run: |
          set -e  # 启用错误时退出，但我们会捕获特定错误
          
          # 检查 webhooks 是否配置
          echo "=== 检查 Webhook 配置 ==="
          if [ -z "$WEBHOOK1" ] && [ -z "$WEBHOOK2" ]; then
            echo "警告: 未配置 Discord webhooks，跳过通知"
            exit 0
          fi
          
          if [ -n "$WEBHOOK1" ]; then
            echo "✓ WEBHOOK1 已配置"
          else
            echo "✗ WEBHOOK1 未配置"
          fi
          
          if [ -n "$WEBHOOK2" ]; then
            echo "✓ WEBHOOK2 已配置"
          else
            echo "✗ WEBHOOK2 未配置"
          fi
          
          echo ""
          echo "=== 提取提交信息 ==="
          # 直接使用最新提交信息
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_BODY=$(git log -1 --pretty=%b)
          
          # 检查是否是 merge commit
          IS_MERGE=$(git log -1 --pretty=%P | grep -c "^")
          
          # 获取合并的提交数量（如果是 merge commit）
          MERGE_COMMIT_COUNT=0
          if [ "$IS_MERGE" -gt 0 ]; then
            MERGE_COMMIT_COUNT=$(git log --oneline HEAD^1..HEAD^2 2>/dev/null | wc -l || echo "0")
            echo "检测到 Merge Commit，合并了 $MERGE_COMMIT_COUNT 个提交"
          fi
          
          echo "提交消息: $COMMIT_MESSAGE"
          echo "提交作者: $COMMIT_AUTHOR"
          echo "提交哈希: $COMMIT_HASH"
          echo "更改文件: $FILE_NAMES"
          
          echo ""
          echo "=== 解析提交类型 ==="
          TYPE=$(echo "$COMMIT_MESSAGE" | sed -E 's/^([a-z]+)(\(.+\))?:.*/\1/')
          SCOPE=$(echo "$COMMIT_MESSAGE" | sed -E 's/^[a-z]+\((.+)\):.*/\1/' | grep -v "^$COMMIT_MESSAGE$" || echo "无")
          SUBJECT=$(echo "$COMMIT_MESSAGE" | sed -E 's/^[a-z]+(\(.+\))?:\s+//')
          
          echo "类型: $TYPE"
          echo "范围: $SCOPE"
          echo "描述: $SUBJECT"
          
          # 根据提交类型设置颜色和图标
          # 颜色方案：使用柔和、语义化的颜色，避免警告色
          case $TYPE in
            "feat") COLOR="5793266"; ICON="✨" ;;        # 紫色 - 新功能
            "fix") COLOR="3447003"; ICON="🐛" ;;         # 蓝色 - 修复（非警告）
            "docs") COLOR="3426654"; ICON="📝" ;;        # 深蓝 - 文档
            "style") COLOR="10070709"; ICON="💎" ;;      # 灰色 - 样式
            "refactor") COLOR="15105570"; ICON="♻️" ;;   # 橙色 - 重构
            "test") COLOR="9442302"; ICON="🧪" ;;        # 紫红 - 测试
            "chore") COLOR="7506394"; ICON="🔧" ;;       # 深灰 - 杂项
            "perf") COLOR="1752220"; ICON="⚡" ;;        # 青色 - 性能
            "ci") COLOR="5832650"; ICON="🤖" ;;          # 灰蓝 - CI
            "build") COLOR="5763719"; ICON="📦" ;;       # 绿色 - 构建
            "revert") COLOR="15158332"; ICON="↩️" ;;     # 深红 - 回滚
            "hotfix") COLOR="16744272"; ICON="🚨" ;;     # 橙红 - 紧急修复
            "release") COLOR="3066993"; ICON="🎉" ;;     # 亮绿 - 发布
            *) COLOR="9807270"; ICON="📝" ;;             # 浅灰 - 其他
          esac
          
          echo "颜色: $COLOR"
          echo "图标: $ICON"

          echo ""
          echo "=== 生成 JSON 负载 ==="
          # 生成 ISO 8601 格式的时间戳
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "时间戳: $TIMESTAMP"
          
          # 对于 merge commit，显示完整的 body 作为描述
          if [ "$IS_MERGE" -gt 0 ] && [ -n "$COMMIT_BODY" ]; then
            # merge commit 使用完整 body
            DESCRIPTION="$COMMIT_BODY"
            TITLE="🔀 $SUBJECT ($MERGE_COMMIT_COUNT commits)"
          else
            DESCRIPTION="$SUBJECT"
            TITLE="$ICON $TYPE 提交"
          fi
          
          # Discord embed description 限制 4096 字符
          if [ ${#DESCRIPTION} -gt 4000 ]; then
            DESCRIPTION="${DESCRIPTION:0:3997}..."
          fi
          
          JSON=$(jq -n --arg title "$TITLE" \
                       --arg description "$DESCRIPTION" \
                       --arg author "$COMMIT_AUTHOR" \
                       --arg hash "$COMMIT_HASH" \
                       --arg timestamp "$TIMESTAMP" \
                       --argjson color $COLOR \
                       '{
                          "embeds": [
                            {
                              "title": $title,
                              "description": $description,
                              "color": $color,
                              "fields": [
                                {
                                  "name": "👤 作者",
                                  "value": $author,
                                  "inline": true
                                },
                                {
                                  "name": "🔗 提交",
                                  "value": "`\($hash)`",
                                  "inline": true
                                }
                              ],
                              "footer": {
                                "text": "Pluto Repository"
                              },
                              "timestamp": $timestamp
                            }
                          ]
                        }')
          
          if [ $? -ne 0 ]; then
            echo "✗ JSON 生成失败"
            exit 1
          fi
          
          echo "✓ JSON 生成成功"
          echo "JSON 长度: ${#JSON} 字符"
          echo "JSON 预览 (前 500 字符):"
          echo "$JSON" | head -c 500
          echo ""

          # 发送到第一个 webhook
          if [ -n "$WEBHOOK1" ]; then
            echo ""
            echo "=== 发送到 WEBHOOK1 ==="
            HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response1.txt -s \
              -H "Content-Type: application/json" \
              -X POST -d "$JSON" "$WEBHOOK1")
            
            echo "HTTP 状态码: $HTTP_CODE"
            echo "响应内容:"
            cat /tmp/response1.txt
            echo ""
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "✓ WEBHOOK1 发送成功"
            else
              echo "✗ WEBHOOK1 发送失败 (HTTP $HTTP_CODE)"
            fi
          fi
          
          # 发送到第二个 webhook
          if [ -n "$WEBHOOK2" ]; then
            echo ""
            echo "=== 发送到 WEBHOOK2 ==="
            HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response2.txt -s \
              -H "Content-Type: application/json" \
              -X POST -d "$JSON" "$WEBHOOK2")
            
            echo "HTTP 状态码: $HTTP_CODE"
            echo "响应内容:"
            cat /tmp/response2.txt
            echo ""
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "✓ WEBHOOK2 发送成功"
            else
              echo "✗ WEBHOOK2 发送失败 (HTTP $HTTP_CODE)"
            fi
          fi
          
          echo ""
          echo "=== 完成 ==="