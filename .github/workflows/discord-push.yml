name: üîî Discord Commit Notifier

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Parse commit and send to both webhooks
        env:
          WEBHOOK1: ${{ secrets.DISCORD_GITHUB_UPDATE }}
          WEBHOOK2: ${{ secrets.DISCORD_GITHUB_UPDATE2 }}
        run: |
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          COMMIT_BODY=$(git log -1 --pretty=%b)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          FILES=$(git diff --name-only HEAD^ HEAD)
          FILE_NAMES=$(echo "$FILES" | xargs -n1 basename | paste -sd ", " -)
          
          # Ëß£ÊûêÊèê‰∫§Á±ªÂûãÂíåËåÉÂõ¥
          TYPE=$(echo "$COMMIT_MESSAGE" | sed -E 's/^([a-z]+)(\(.+\))?:.*/\1/')
          SCOPE=$(echo "$COMMIT_MESSAGE" | sed -E 's/^[a-z]+\((.+)\):.*/\1/' | grep -v "^$COMMIT_MESSAGE$" || echo "Êó†")
          SUBJECT=$(echo "$COMMIT_MESSAGE" | sed -E 's/^[a-z]+(\(.+\))?:\s+//')
          
          # Ê†πÊçÆÊèê‰∫§Á±ªÂûãËÆæÁΩÆÈ¢úËâ≤ÂíåÂõæÊ†á
          case $TYPE in
            "feat") COLOR="5814780"; ICON="‚ú®" ;;
            "fix") COLOR="15548997"; ICON="üêõ" ;;
            "docs") COLOR="2196944"; ICON="üìù" ;;
            "style") COLOR="12370112"; ICON="üíé" ;;
            "refactor") COLOR="16705372"; ICON="‚ôªÔ∏è" ;;
            "test") COLOR="8311585"; ICON="üß™" ;;
            "chore") COLOR="8421504"; ICON="üîß" ;;
            "perf") COLOR="16776960"; ICON="‚ö°" ;;
            "ci") COLOR="6759752"; ICON="ü§ñ" ;;
            "build") COLOR="10197915"; ICON="üì¶" ;;
            "revert") COLOR="16711680"; ICON="‚Ü©Ô∏è" ;;
            "hotfix") COLOR="16711782"; ICON="üö®" ;;
            "release") COLOR="65280"; ICON="üéâ" ;;
            *) COLOR="14540253"; ICON="üìù" ;;
          esac

          JSON=$(jq -n --arg title "$ICON $TYPE Êèê‰∫§" \
                       --arg description "$SUBJECT" \
                       --arg author "$COMMIT_AUTHOR" \
                       --arg hash "$COMMIT_HASH" \
                       --arg scope "$SCOPE" \
                       --arg files "$FILE_NAMES" \
                       --arg body "$COMMIT_BODY" \
                       --argjson color $COLOR \
                       '{
                          "embeds": [
                            {
                              "title": $title,
                              "description": $description,
                              "color": $color,
                              "fields": [
                                {
                                  "name": "üë§ ‰ΩúËÄÖ",
                                  "value": $author,
                                  "inline": true
                                },
                                {
                                  "name": "üîó Êèê‰∫§",
                                  "value": "`\($hash)`",
                                  "inline": true
                                },
                                {
                                  "name": "üìÇ ËåÉÂõ¥",
                                  "value": ($scope // "Êó†"),
                                  "inline": true
                                },
                                {
                                  "name": "üóÇÔ∏è Êõ¥Êñ∞Êñá‰ª∂",
                                  "value": ($files // "Êó†"),
                                  "inline": false
                                }
                              ],
                              "footer": {
                                "text": "Pluto Repository"
                              },
                              "timestamp": now
                            }
                          ]
                        }')

          curl -H "Content-Type: application/json" -X POST -d "$JSON" "$WEBHOOK1"
          curl -H "Content-Type: application/json" -X POST -d "$JSON" "$WEBHOOK2"