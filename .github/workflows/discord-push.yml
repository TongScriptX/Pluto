name: ğŸ”” Discord Commit Notifier

on:
  push:
    branches:
      - main

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Parse commit and send to both webhooks
        env:
          WEBHOOK1: ${{ secrets.DISCORD_GITHUB_UPDATE }}
          WEBHOOK2: ${{ secrets.DISCORD_GITHUB_UPDATE2 }}
        run: |
          set -e  # å¯ç”¨é”™è¯¯æ—¶é€€å‡ºï¼Œä½†æˆ‘ä»¬ä¼šæ•è·ç‰¹å®šé”™è¯¯
          
          # æ£€æŸ¥ webhooks æ˜¯å¦é…ç½®
          echo "=== æ£€æŸ¥ Webhook é…ç½® ==="
          if [ -z "$WEBHOOK1" ] && [ -z "$WEBHOOK2" ]; then
            echo "è­¦å‘Š: æœªé…ç½® Discord webhooksï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          if [ -n "$WEBHOOK1" ]; then
            echo "âœ“ WEBHOOK1 å·²é…ç½®"
          else
            echo "âœ— WEBHOOK1 æœªé…ç½®"
          fi
          
          if [ -n "$WEBHOOK2" ]; then
            echo "âœ“ WEBHOOK2 å·²é…ç½®"
          else
            echo "âœ— WEBHOOK2 æœªé…ç½®"
          fi
          
          echo ""
          echo "=== æå–æäº¤ä¿¡æ¯ ==="
          COMMIT_MESSAGE=$(git log -1 --pretty=%s)
          COMMIT_BODY=$(git log -1 --pretty=%b)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          FILES=$(git diff --name-only HEAD^ HEAD || echo "")
          FILE_NAMES=$(echo "$FILES" | xargs -n1 basename 2>/dev/null | paste -sd ", " - || echo "æ— æ›´æ”¹")
          
          echo "æäº¤æ¶ˆæ¯: $COMMIT_MESSAGE"
          echo "æäº¤ä½œè€…: $COMMIT_AUTHOR"
          echo "æäº¤å“ˆå¸Œ: $COMMIT_HASH"
          echo "æ›´æ”¹æ–‡ä»¶: $FILE_NAMES"
          
          echo ""
          echo "=== è§£ææäº¤ç±»å‹ ==="
          TYPE=$(echo "$COMMIT_MESSAGE" | sed -E 's/^([a-z]+)(\(.+\))?:.*/\1/')
          SCOPE=$(echo "$COMMIT_MESSAGE" | sed -E 's/^[a-z]+\((.+)\):.*/\1/' | grep -v "^$COMMIT_MESSAGE$" || echo "æ— ")
          SUBJECT=$(echo "$COMMIT_MESSAGE" | sed -E 's/^[a-z]+(\(.+\))?:\s+//')
          
          echo "ç±»å‹: $TYPE"
          echo "èŒƒå›´: $SCOPE"
          echo "æè¿°: $SUBJECT"
          
          # æ ¹æ®æäº¤ç±»å‹è®¾ç½®é¢œè‰²å’Œå›¾æ ‡
          case $TYPE in
            "feat") COLOR="5814780"; ICON="âœ¨" ;;
            "fix") COLOR="15548997"; ICON="ğŸ›" ;;
            "docs") COLOR="2196944"; ICON="ğŸ“" ;;
            "style") COLOR="12370112"; ICON="ğŸ’" ;;
            "refactor") COLOR="16705372"; ICON="â™»ï¸" ;;
            "test") COLOR="8311585"; ICON="ğŸ§ª" ;;
            "chore") COLOR="8421504"; ICON="ğŸ”§" ;;
            "perf") COLOR="16776960"; ICON="âš¡" ;;
            "ci") COLOR="6759752"; ICON="ğŸ¤–" ;;
            "build") COLOR="10197915"; ICON="ğŸ“¦" ;;
            "revert") COLOR="16711680"; ICON="â†©ï¸" ;;
            "hotfix") COLOR="16711782"; ICON="ğŸš¨" ;;
            "release") COLOR="65280"; ICON="ğŸ‰" ;;
            *) COLOR="14540253"; ICON="ğŸ“" ;;
          esac
          
          echo "é¢œè‰²: $COLOR"
          echo "å›¾æ ‡: $ICON"

          echo ""
          echo "=== ç”Ÿæˆ JSON è´Ÿè½½ ==="
          JSON=$(jq -n --arg title "$ICON $TYPE æäº¤" \
                       --arg description "$SUBJECT" \
                       --arg author "$COMMIT_AUTHOR" \
                       --arg hash "$COMMIT_HASH" \
                       --arg scope "$SCOPE" \
                       --arg files "$FILE_NAMES" \
                       --arg body "$COMMIT_BODY" \
                       --argjson color $COLOR \
                       '{
                          "embeds": [
                            {
                              "title": $title,
                              "description": $description,
                              "color": $color,
                              "fields": [
                                {
                                  "name": "ğŸ‘¤ ä½œè€…",
                                  "value": $author,
                                  "inline": true
                                },
                                {
                                  "name": "ğŸ”— æäº¤",
                                  "value": "`\($hash)`",
                                  "inline": true
                                },
                                {
                                  "name": "ğŸ“‚ èŒƒå›´",
                                  "value": ($scope // "æ— "),
                                  "inline": true
                                },
                                {
                                  "name": "ğŸ—‚ï¸ æ›´æ–°æ–‡ä»¶",
                                  "value": ($files // "æ— "),
                                  "inline": false
                                }
                              ],
                              "footer": {
                                "text": "Pluto Repository"
                              },
                              "timestamp": now
                            }
                          ]
                        }')
          
          if [ $? -ne 0 ]; then
            echo "âœ— JSON ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          
          echo "âœ“ JSON ç”ŸæˆæˆåŠŸ"
          echo "JSON é•¿åº¦: ${#JSON} å­—ç¬¦"
          echo "JSON é¢„è§ˆ (å‰ 500 å­—ç¬¦):"
          echo "$JSON" | head -c 500
          echo ""

          # å‘é€åˆ°ç¬¬ä¸€ä¸ª webhook
          if [ -n "$WEBHOOK1" ]; then
            echo ""
            echo "=== å‘é€åˆ° WEBHOOK1 ==="
            HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response1.txt -s \
              -H "Content-Type: application/json" \
              -X POST -d "$JSON" "$WEBHOOK1")
            
            echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”å†…å®¹:"
            cat /tmp/response1.txt
            echo ""
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "âœ“ WEBHOOK1 å‘é€æˆåŠŸ"
            else
              echo "âœ— WEBHOOK1 å‘é€å¤±è´¥ (HTTP $HTTP_CODE)"
            fi
          fi
          
          # å‘é€åˆ°ç¬¬äºŒä¸ª webhook
          if [ -n "$WEBHOOK2" ]; then
            echo ""
            echo "=== å‘é€åˆ° WEBHOOK2 ==="
            HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response2.txt -s \
              -H "Content-Type: application/json" \
              -X POST -d "$JSON" "$WEBHOOK2")
            
            echo "HTTP çŠ¶æ€ç : $HTTP_CODE"
            echo "å“åº”å†…å®¹:"
            cat /tmp/response2.txt
            echo ""
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "âœ“ WEBHOOK2 å‘é€æˆåŠŸ"
            else
              echo "âœ— WEBHOOK2 å‘é€å¤±è´¥ (HTTP $HTTP_CODE)"
            fi
          fi
          
          echo ""
          echo "=== å®Œæˆ ==="