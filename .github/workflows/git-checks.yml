name: üîç Git Standards Check

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  git-standards-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch name
        run: |
          BRANCH=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}
          echo "Checking branch: $BRANCH"
          if [[ "$BRANCH" == "main" || "$BRANCH" == "develop" ]]; then
            echo "‚úÖ Protected branch name is valid"
          elif ! [[ "$BRANCH" =~ ^(feat|fix|docs|style|refactor|test|chore|hotfix|release)\/([a-z0-9.-]+)$ ]]; then
            echo "::error::Branch name '$BRANCH' does not follow <type>/<ticket>-<desc> pattern"
            echo "::error::Valid types: feat, fix, docs, style, refactor, test, chore, hotfix, release"
            exit 1
          else
            echo "‚úÖ Branch name follows standards"
          fi

      - name: Check commit message
        uses: wagoid/commitlint-github-action@v5.5.2
        timeout-minutes: 5
        continue-on-error: false

      - name: Fallback commitlint check
        if: failure()
        run: |
          npm install -g @commitlint/cli @commitlint/config-conventional
          echo "Running fallback commitlint check..."
          git log --format=%s -n 1 | npx commitlint

      - name: Check for merge commits
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            MERGE_COMMITS=$(git rev-list --no-merges origin/main..HEAD | wc -l)
            TOTAL_COMMITS=$(git rev-list origin/main..HEAD | wc -l)
            if [ "$MERGE_COMMITS" -ne "$TOTAL_COMMITS" ]; then
              echo "::warning::PR contains merge commits. Consider rebase to keep linear history."
            fi
          fi