name: ðŸ“Š Repository Statistics

on:
  schedule:
    # æ¯å°æ—¶æ›´æ–°ç»Ÿè®¡
    - cron: '0 * * * *'
  workflow_dispatch:
  push:
    branches: [main, develop]

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate repository stats
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './.github/stats.json';
            
            // èŽ·å–ä»“åº“ä¿¡æ¯
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // èŽ·å–è´¡çŒ®è€…ä¿¡æ¯
            const { data: contributors } = await github.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // èŽ·å–æœ€æ–°å‘å¸ƒä¿¡æ¯
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 1
            });
            
            // èŽ·å–è¯­è¨€ä¿¡æ¯
            const { data: languages } = await github.rest.repos.listLanguages({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            
            // ç»Ÿè®¡ä¿¡æ¯
            const stats = {
              updated: new Date().toISOString(),
              repository: {
                name: repo.name,
                description: repo.description,
                stars: repo.stargazers_count,
                forks: repo.forks_count,
                watchers: repo.watchers_count,
                open_issues: repo.open_issues_count,
                size: repo.size,
                language: repo.language,
                created_at: repo.created_at,
                updated_at: repo.updated_at,
                pushed_at: repo.pushed_at,
                default_branch: repo.default_branch,
                license: repo.license ? repo.license.name : null,
                topics: repo.topics
              },
              contributors: contributors.map(contributor => ({
                login: contributor.login,
                contributions: contributor.contributions,
                type: contributor.type
              })),
              latest_release: releases.length > 0 ? {
                tag_name: releases[0].tag_name,
                name: releases[0].name,
                published_at: releases[0].published_at,
                assets: releases[0].assets.length
              } : null,
              languages: Object.keys(languages).map(lang => ({
                name: lang,
                bytes: languages[lang]
              }))
            };
            
            // å†™å…¥ç»Ÿè®¡æ–‡ä»¶
            fs.writeFileSync(path, JSON.stringify(stats, null, 2));
            console.log('Statistics updated successfully');

      - name: Commit updated stats
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update repository statistics"
          file_pattern: ".github/stats.json"
          commit_user_name: "GitHub Action"
          commit_user_email: "action@github.com"
          skip_dirty_check: false