name: ðŸ”€ Merge Develop to Main

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'ç¡®è®¤åˆå¹¶ develop åˆ° main'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Check for changes
        id: check
        run: |
          git fetch origin main
          git fetch origin develop
          
          COMMITS=$(git log origin/main..origin/develop --oneline | wc -l)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          
          if [ "$COMMITS" -eq 0 ]; then
            echo "::notice::develop ä¸Ž main åŒæ­¥ï¼Œæ— éœ€åˆå¹¶"
          fi

      - name: Get commit messages
        if: steps.check.outputs.commits != '0'
        id: commits
        run: |
          # èŽ·å–æäº¤ä¿¡æ¯
          COMMIT_MESSAGES=$(git log origin/main..origin/develop --pretty=format:"- %s")
          echo "$COMMIT_MESSAGES" > /tmp/commit_messages.txt
          
          # èŽ·å–æ–‡ä»¶å˜æ›´ç»Ÿè®¡
          FILE_CHANGES=$(git diff origin/main...origin/develop --stat | tail -1)
          echo "$FILE_CHANGES" > /tmp/file_changes.txt

      - name: Summarize with AI
        if: steps.check.outputs.commits != '0'
        id: summarize
        env:
          AI_API_URL: ${{ secrets.AI_API_URL }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
        run: |
          COMMIT_MSGS=$(cat /tmp/commit_messages.txt)
          FILE_STATS=$(cat /tmp/file_changes.txt)
          
          # é»˜è®¤ API é…ç½®
          API_URL="${AI_API_URL:-https://api.openai.com/v1/chat/completions}"
          MODEL="${AI_MODEL:-gpt-4o-mini}"
          
          # æž„å»ºè¯·æ±‚
          PROMPT="ä½ æ˜¯ä¸€ä¸ª Git æäº¤ä¿¡æ¯æ€»ç»“åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹ develop åˆ†æ”¯çš„ä¿®æ”¹å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´çš„åˆå¹¶æäº¤ä¿¡æ¯ã€‚

è¦æ±‚ï¼š
1. æ€»ç»“ä¸»è¦ä¿®æ”¹ç±»åˆ«ï¼ˆfeat/fix/style/refactor ç­‰ï¼‰
2. æ¯ä¸ªç±»åˆ«ä¸‹åˆ—å‡ºå…³é”®ä¿®æ”¹ï¼ˆä¸è¦é‡å¤åˆ—å‡ºç›¸åŒç±»åž‹çš„ä¿®æ”¹ï¼‰
3. ä½¿ç”¨ä¸­æ–‡
4. æ ¼å¼æ¸…æ™°ï¼Œé€‚åˆä½œä¸º commit message
5. ç›´æŽ¥è¾“å‡ºå†…å®¹ï¼Œä¸è¦æœ‰ä»£ç å—æ ‡è®°

æäº¤åˆ—è¡¨:
$COMMIT_MSGS

æ–‡ä»¶å˜æ›´ç»Ÿè®¡:
$FILE_STATS

è¯·ç›´æŽ¥è¾“å‡ºæ€»ç»“å†…å®¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
merge: åˆå¹¶ develop åˆ†æ”¯

## æ–°åŠŸèƒ½
- xxx

## ä¿®å¤  
- xxx

## æ ·å¼
- xxx"

          if [ -z "$AI_API_KEY" ]; then
            echo "::warning::æœªé…ç½® AI_API_KEYï¼Œä½¿ç”¨ç®€å•æ€»ç»“"
            SUMMARY="merge: åˆå¹¶ develop åˆ†æ”¯

æœ¬æ¬¡åˆå¹¶åŒ…å«ä»¥ä¸‹ä¿®æ”¹:
$COMMIT_MSGS"
          else
            # è°ƒç”¨ AI API
            RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $AI_API_KEY" \
              -d "{
                \"model\": \"$MODEL\",
                \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}],
                \"max_tokens\": 1000,
                \"temperature\": 0.3
              }")
            
            SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null)
            
            if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
              echo "::warning::AI API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ€»ç»“"
              SUMMARY="merge: åˆå¹¶ develop åˆ†æ”¯

æœ¬æ¬¡åˆå¹¶åŒ…å«ä»¥ä¸‹ä¿®æ”¹:
$COMMIT_MSGS"
            fi
          fi
          
          # ä¿å­˜æ€»ç»“
          echo "$SUMMARY" > /tmp/merge_message.txt
          
          # è¾“å‡ºé¢„è§ˆ
          echo "========== åˆå¹¶æäº¤ä¿¡æ¯ =========="
          cat /tmp/merge_message.txt
          echo "=================================="

      - name: Merge to main
        if: steps.check.outputs.commits != '0'
        run: |
          git checkout main
          git pull origin main
          
          # ä½¿ç”¨ç”Ÿæˆçš„æ€»ç»“ä½œä¸ºåˆå¹¶æäº¤ä¿¡æ¯
          MERGE_MSG=$(cat /tmp/merge_message.txt)
          
          git merge origin/develop --no-ff -m "$MERGE_MSG"
          git push origin main

      - name: Switch back to develop
        if: steps.check.outputs.commits != '0'
        run: |
          git checkout develop
          git pull origin develop

      - name: Summary
        run: |
          if [ "${{ steps.check.outputs.commits }}" = "0" ]; then
            echo "### âœ… æ— éœ€åˆå¹¶" >> $GITHUB_STEP_SUMMARY
            echo "develop ä¸Ž main å·²åŒæ­¥" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… åˆå¹¶å®Œæˆ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "åˆå¹¶ **${{ steps.check.outputs.commits }}** ä¸ªæäº¤åˆ° main åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### åˆå¹¶æäº¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat /tmp/merge_message.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
