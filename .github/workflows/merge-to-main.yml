name: ðŸ”€ Merge Develop to Main

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: write

jobs:
  merge:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Check for changes
        id: check
        run: |
          git fetch origin main
          git fetch origin develop
          
          COMMITS=$(git log origin/main..origin/develop --oneline | wc -l)
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          
          if [ "$COMMITS" -eq 0 ]; then
            echo "::notice::develop ä¸Ž main åŒæ­¥ï¼Œæ— éœ€åˆå¹¶"
          fi

      - name: Get commit messages
        if: steps.check.outputs.commits != '0'
        id: commits
        run: |
          COMMIT_MESSAGES=$(git log origin/main..origin/develop --pretty=format:"- %s")
          echo "$COMMIT_MESSAGES" > /tmp/commit_messages.txt
          
          FILE_CHANGES=$(git diff origin/main...origin/develop --stat | tail -1)
          echo "$FILE_CHANGES" > /tmp/file_changes.txt

      - name: Summarize with AI
        if: steps.check.outputs.commits != '0'
        id: summarize
        env:
          AI_API_URL: ${{ secrets.AI_API_URL }}
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL }}
        run: |
          COMMIT_MSGS=$(cat /tmp/commit_messages.txt)
          FILE_STATS=$(cat /tmp/file_changes.txt)
          
          API_URL="${AI_API_URL:-https://api.openai.com/v1/chat/completions}"
          MODEL="${AI_MODEL:-gpt-4o-mini}"
          
          if [ -z "$AI_API_KEY" ]; then
            echo "::warning::æœªé…ç½® AI_API_KEYï¼Œä½¿ç”¨ç®€å•æ€»ç»“"
            cat > /tmp/merge_message.txt << 'EOF'
merge: åˆå¹¶ develop åˆ†æ”¯

æœ¬æ¬¡åˆå¹¶åŒ…å«ä»¥ä¸‹ä¿®æ”¹:
EOF
            echo "$COMMIT_MSGS" >> /tmp/merge_message.txt
          else
            RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $AI_API_KEY" \
              -d "{
                \"model\": \"$MODEL\",
                \"messages\": [{\"role\": \"user\", \"content\": \"è¯·æ ¹æ®ä»¥ä¸‹æäº¤åˆ—è¡¨ç”Ÿæˆä¸€ä¸ªç®€æ´çš„åˆå¹¶æäº¤ä¿¡æ¯ï¼Œä½¿ç”¨ä¸­æ–‡ï¼Œæ ¼å¼ä¸º merge: å¼€å¤´ï¼š\n$COMMIT_MSGS\"}],
                \"max_tokens\": 500,
                \"temperature\": 0.3
              }")
            
            SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content' 2>/dev/null)
            
            if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
              echo "::warning::AI API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ€»ç»“"
              cat > /tmp/merge_message.txt << 'EOF'
merge: åˆå¹¶ develop åˆ†æ”¯

æœ¬æ¬¡åˆå¹¶åŒ…å«ä»¥ä¸‹ä¿®æ”¹:
EOF
              echo "$COMMIT_MSGS" >> /tmp/merge_message.txt
            else
              echo "$SUMMARY" > /tmp/merge_message.txt
            fi
          fi
          
          echo "========== åˆå¹¶æäº¤ä¿¡æ¯ =========="
          cat /tmp/merge_message.txt
          echo "=================================="

      - name: Merge to main
        if: steps.check.outputs.commits != '0'
        run: |
          git checkout main
          git pull origin main
          
          MERGE_MSG=$(cat /tmp/merge_message.txt)
          
          git merge origin/develop --no-ff -m "$MERGE_MSG"
          git push origin main

      - name: Summary
        if: steps.check.outputs.commits != '0'
        run: |
          echo "### âœ… åˆå¹¶å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "åˆå¹¶ **${{ steps.check.outputs.commits }}** ä¸ªæäº¤åˆ° main åˆ†æ”¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### åˆå¹¶æäº¤ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat /tmp/merge_message.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY